<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Link Extractor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f9fafb;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container max-w-4xl mx-auto p-4 bg-gray-50 min-h-screen">
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">File Link Extractor</h1>
            <p class="text-gray-600">Enter a Terabox or compatible URL to extract file information</p>
            <div class="mt-2 text-sm text-gray-500">
                Supported domains: teraboxapp.com, terabox.com, 1024tera.com, terabox.app, teraboxpro.com, 
                nephobox.com, 4funbox.com, dubox.com, and more
            </div>
        </div>

        <form id="urlForm" class="mb-8">
            <div class="flex flex-col md:flex-row gap-2">
                <input
                    type="text"
                    id="urlInput"
                    placeholder="Enter URL (e.g., https://teraboxapp.com/s/... or any supported domain)"
                    class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                />
                <button
                    type="submit"
                    id="submitButton"
                    class="bg-blue-600 text-white py-3 px-6 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    Extract Info
                </button>
            </div>
        </form>

        <div id="errorContainer" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-md hidden">
            <p id="errorMessage"></p>
            <button 
                id="debugButton"
                class="text-blue-600 text-sm mt-2 underline"
            >
                Show Debug Info
            </button>
            
            <div id="debugInfo" class="mt-3 p-3 bg-gray-800 text-white rounded text-xs overflow-x-auto hidden">
                <p id="apiUrlText">API URL: </p>
                <p class="mt-2">Try opening this URL directly in your browser to test the API.</p>
                <p id="extractedUrlText" class="mt-2">Extracted URL: </p>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center py-4 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Processing your request...</p>
        </div>

        <div id="fileInfoContainer" class="bg-white p-6 rounded-md shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">File Information</h2>
            
            <div class="space-y-4">
                <div class="border-b pb-3">
                    <h3 class="text-sm font-medium text-gray-500">Filename</h3>
                    <p id="filename" class="mt-1 text-lg">Unknown</p>
                </div>
                
                <div class="border-b pb-3">
                    <h3 class="text-sm font-medium text-gray-500">File Size</h3>
                    <p id="filesize" class="mt-1 text-lg">Unknown</p>
                </div>
                
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Download Link</h3>
                    <div id="downloadLinkContainer" class="mt-2">
                        <a
                            id="downloadButton"
                            href="#"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="inline-block bg-green-600 text-white py-2 px-4 rounded-md font-medium hover:bg-green-700"
                        >
                            Download File
                        </a>
                        <div id="downloadLinkText" class="mt-3 p-2 bg-gray-100 rounded-md text-sm text-gray-800 break-all">
                        </div>
                    </div>
                    <p id="noLinkMessage" class="mt-1 text-red-600 hidden">No download link available</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlForm = document.getElementById('urlForm');
            const urlInput = document.getElementById('urlInput');
            const submitButton = document.getElementById('submitButton');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const debugButton = document.getElementById('debugButton');
            const debugInfo = document.getElementById('debugInfo');
            const apiUrlText = document.getElementById('apiUrlText');
            const extractedUrlText = document.getElementById('extractedUrlText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const fileInfoContainer = document.getElementById('fileInfoContainer');
            const filename = document.getElementById('filename');
            const filesize = document.getElementById('filesize');
            const downloadLinkContainer = document.getElementById('downloadLinkContainer');
            const downloadButton = document.getElementById('downloadButton');
            const downloadLinkText = document.getElementById('downloadLinkText');
            const noLinkMessage = document.getElementById('noLinkMessage');

            let debugMode = false;

            // Function to extract URL
            function extractTeraboxUrl(inputUrl) {
                const domainPatterns = [
                    'teraboxapp\\.com',
                    'terabox\\.com',
                    '1024tera\\.com',
                    'terabox\\.app',
                    'teraboxpro\\.com',
                    'teraboxpro\\.app',
                    'nephobox\\.com',
                    'nephocloud\\.com',
                    '4funbox\\.com',
                    'teraboxapp\\.cc',
                    'dubox\\.com',
                    'botsapp\\.me',
                    'boteapp\\.me',
                    'ufile\\.io',
                    'mirrorcreator\\.com',
                    'mirrorace\\.com',
                    'mirrorace\\.org'
                ];
                
                const regex = new RegExp(`(https?:\\/\\/(?:www\\.)?(?:${domainPatterns.join('|')})\\/s\\/[a-zA-Z0-9_\\-\\.]+)`, 'i');
                const match = inputUrl.match(regex);
                return match ? match[1] : inputUrl;
            }

            // Function to format file size
            function formatFileSize(bytes) {
                if (!bytes) return 'Unknown';
                
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let size = bytes;
                let unitIndex = 0;
                
                while (size >= 1024 && unitIndex < units.length - 1) {
                    size /= 1024;
                    unitIndex++;
                }
                
                return `${size.toFixed(2)} ${units[unitIndex]}`;
            }

            // Toggle debug info
            debugButton.addEventListener('click', function() {
                debugMode = !debugMode;
                debugInfo.classList.toggle('hidden');
                debugButton.textContent = debugMode ? 'Hide Debug Info' : 'Show Debug Info';
            });

            // Handle form submission
            urlForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const url = urlInput.value.trim();
                
                if (!url) {
                    showError('Please enter a valid URL');
                    return;
                }
                
                setLoading(true);
                hideError();
                hideFileInfo();
                
                try {
                    // Extract the URL from any wrapper
                    const extractedUrl = extractTeraboxUrl(url);
                    console.log("Extracted URL:", extractedUrl);
                    
                    // Update debug info
                    const apiUrl = `https://terabox-test-api.wd-zone.workers.dev/?url=${encodeURIComponent(extractedUrl)}`;
                    apiUrlText.textContent = `API URL: ${apiUrl}`;
                    extractedUrlText.textContent = `Extracted URL: ${extractedUrl}`;
                    
                    // Basic validation for URL format
                    if (extractedUrl === url && !url.match(/https?:\/\/(www\.)?[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+\/s\//i)) {
                        throw new Error('The URL format is not recognized. Please enter a supported sharing URL.');
                    }
                    
                    console.log("API URL:", apiUrl);
                    
                    // Implement a timeout for the fetch request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30-second timeout
                    
                    try {
                        // Make the API request
                        const response = await fetch(apiUrl, {
                            signal: controller.signal,
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        clearTimeout(timeoutId);
                        
                        console.log("Response status:", response.status);
                        
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status} - ${response.statusText}`);
                        }
                        
                        // Parse the response
                        const data = await response.json();
                        console.log("API response:", data);
                        
                        // Handle API error responses
                        if (data.error) {
                            throw new Error(`API error: ${data.error}`);
                        }
                        
                        // Validate the response data
                        if (!data || typeof data !== 'object') {
                            throw new Error('Invalid response format from API');
                        }
                        
                        if (!data.filename && !data.size && !data.downloadLink) {
                            throw new Error('No file information could be extracted from this URL. The API may be down or the URL may not be supported.');
                        }
                        
                        // Display the file info
                        showFileInfo(data);
                    } catch (fetchError) {
                        if (fetchError.name === 'AbortError') {
                            throw new Error('Request timed out. The API service may be unavailable.');
                        } else {
                            throw fetchError;
                        }
                    }
                } catch (err) {
                    console.error("Error:", err);
                    showError(err.message || 'Failed to extract file information');
                } finally {
                    setLoading(false);
                }
            });

            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            }

            // Hide error message
            function hideError() {
                errorContainer.classList.add('hidden');
            }

            // Set loading state
            function setLoading(isLoading) {
                if (isLoading) {
                    submitButton.textContent = 'Processing...';
                    submitButton.disabled = true;
                    loadingIndicator.classList.remove('hidden');
                } else {
                    submitButton.textContent = 'Extract Info';
                    submitButton.disabled = false;
                    loadingIndicator.classList.add('hidden');
                }
            }

            // Show file information
            function showFileInfo(data) {
                filename.textContent = data.filename || 'Unknown';
                filesize.textContent = formatFileSize(data.size);
                
                if (data.downloadLink) {
                    downloadButton.href = data.downloadLink;
                    downloadLinkText.textContent = data.downloadLink;
                    downloadLinkContainer.classList.remove('hidden');
                    noLinkMessage.classList.add('hidden');
                } else {
                    downloadLinkContainer.classList.add('hidden');
                    noLinkMessage.classList.remove('hidden');
                }
                
                fileInfoContainer.classList.remove('hidden');
            }

            // Hide file information
            function hideFileInfo() {
                fileInfoContainer.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
